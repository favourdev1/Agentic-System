<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agentic Console</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              display: ['Outfit', 'sans-serif'],
            },
            colors: {
              brand: {
                50: '#f0f7ff',
                100: '#e0effe',
                200: '#b9dffe',
                300: '#7cc2fd',
                400: '#36a4fa',
                500: '#0c87eb',
                600: '#0069c9',
                700: '#0054a3',
                800: '#044886',
                900: '#093c6f',
                950: '#06264a',
              },
              dark: {
                50: '#f6f6f7',
                100: '#e1e1e3',
                200: '#c2c2c7',
                300: '#9d9ea6',
                400: '#757680',
                500: '#5a5b66',
                600: '#43444d',
                700: '#313238',
                800: '#212226',
                850: '#1a1b1e',
                900: '#121316',
                950: '#0a0a0c',
              }
            }
          }
        }
      }
    </script>
    <style>
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
      ::-webkit-scrollbar-thumb:hover { background: #52525b; }
      
      .glass {
        background: rgba(26, 27, 30, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .message-enter {
        animation: slideIn 0.3s ease-out forwards;
      }

      @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .gradient-bg {
        background: radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                    radial-gradient(circle at 100% 100%, rgba(147, 51, 234, 0.05) 0%, transparent 50%);
      }
    </style>
  </head>
  <body class="min-h-screen bg-dark-950 text-dark-100 font-sans antialiased gradient-bg">
    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar / Developer Console -->
      <aside id="devPanel" class="fixed inset-y-0 left-0 z-50 w-80 bg-dark-900 border-r border-dark-800 flex flex-col -translate-x-full transition-transform duration-300 lg:relative lg:translate-x-0">
        <div class="h-14 flex items-center justify-between px-6 border-b border-dark-800 shrink-0">
          <h2 class="font-display font-bold text-lg text-brand-400">Agent Console</h2>
          <button id="closeDevBtn" class="lg:hidden p-2 text-dark-400 hover:text-dark-100">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <!-- Sidebar Tabs -->
        <div class="flex border-b border-dark-800 shrink-0">
          <button onclick="switchTab('controls')" id="tab-controls" class="flex-1 py-3 text-xs font-semibold uppercase tracking-wider border-b-2 border-brand-500 text-brand-400 bg-dark-800/30">Params</button>
          <button onclick="switchTab('events')" id="tab-events" class="flex-1 py-3 text-xs font-semibold uppercase tracking-wider border-b-2 border-transparent text-dark-400 hover:text-dark-200">Log</button>
          <button onclick="switchTab('raw')" id="tab-raw" class="flex-1 py-3 text-xs font-semibold uppercase tracking-wider border-b-2 border-transparent text-dark-400 hover:text-dark-200">JSON</button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar">
          <!-- Controls Tab -->
          <div id="panel-controls" class="p-6 space-y-6">
            <section class="space-y-4">
              <label class="block group">
                <span class="text-[11px] font-bold uppercase tracking-widest text-dark-500 group-focus-within:text-brand-400 transition-colors">Invoke URL</span>
                <input id="urlInput" class="mt-1.5 w-full bg-dark-850 border border-dark-700 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500/20 transition-all" />
              </label>

              <div class="grid grid-cols-2 gap-3">
                <label class="flex items-center gap-3 p-3 bg-dark-850 border border-dark-700 rounded-xl cursor-pointer hover:bg-dark-800 transition-colors">
                  <input id="streamToggle" type="checkbox" class="w-4 h-4 rounded border-dark-700 text-brand-500 focus:ring-brand-500/20 bg-dark-900" checked />
                  <span class="text-xs font-medium">Stream</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-dark-850 border border-dark-700 rounded-xl cursor-pointer hover:bg-dark-800 transition-colors">
                  <input id="traceToggle" type="checkbox" class="w-4 h-4 rounded border-dark-700 text-brand-500 focus:ring-brand-500/20 bg-dark-900" checked />
                  <span class="text-xs font-medium">Trace</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-dark-850 border border-dark-700 rounded-xl cursor-pointer hover:bg-dark-800 transition-colors">
                  <input id="uiToggle" type="checkbox" class="w-4 h-4 rounded border-dark-700 text-brand-500 focus:ring-brand-500/20 bg-dark-900" checked />
                  <span class="text-xs font-medium">Gen UI</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-dark-850 border border-dark-700 rounded-xl cursor-pointer hover:bg-dark-800 transition-colors">
                  <input id="budgetEnabled" type="checkbox" class="w-4 h-4 rounded border-dark-700 text-brand-500 focus:ring-brand-500/20 bg-dark-900" />
                  <span class="text-xs font-medium">Budget</span>
                </label>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <label class="block">
                  <span class="text-[11px] font-bold uppercase tracking-widest text-dark-500">Session ID</span>
                  <input id="sessionIdInput" placeholder="Auto" class="mt-1.5 w-full bg-dark-850 border border-dark-700 rounded-xl px-4 py-2 text-sm outline-none focus:border-brand-500 transition-all font-mono" />
                </label>
                <label class="block">
                  <span class="text-[11px] font-bold uppercase tracking-widest text-dark-500">Steps</span>
                  <input id="budgetInput" type="number" min="1" value="2" class="mt-1.5 w-full bg-dark-850 border border-dark-700 rounded-xl px-4 py-2 text-sm outline-none focus:border-brand-500 transition-all" />
                </label>
              </div>
            </section>

            <section class="space-y-3 pt-6 border-t border-dark-800">
              <span class="text-[11px] font-bold uppercase tracking-widest text-dark-500">Payload Override</span>
              <textarea id="payloadInput" rows="10" class="w-full bg-dark-950 border border-dark-700 rounded-xl p-4 text-[11px] font-mono outline-none focus:border-brand-500 transition-all resize-none custom-scrollbar"></textarea>
              <div class="flex gap-3">
                <button id="syncPayloadBtn" class="flex-1 py-2.5 bg-dark-800 hover:bg-dark-700 rounded-xl text-xs font-semibold transition-colors">Sync</button>
                <button id="clearChatBtn" class="flex-1 py-2.5 bg-dark-800 hover:bg-dark-700 rounded-xl text-xs font-semibold transition-colors">Clear</button>
              </div>
            </section>
          </div>

          <!-- Events Tab -->
          <div id="panel-events" class="hidden h-full flex flex-col">
            <div class="p-4 flex-1 overflow-auto">
              <pre id="eventsPanel" class="text-[10px] leading-relaxed font-mono text-brand-300 whitespace-pre-wrap"></pre>
            </div>
          </div>

          <!-- Raw JSON Tab -->
          <div id="panel-raw" class="hidden h-full flex flex-col p-4">
            <pre id="jsonPanel" class="flex-1 overflow-auto text-[10px] font-mono text-green-400 bg-dark-950 p-4 rounded-xl border border-dark-800"></pre>
          </div>
        </div>
      </aside>

      <div id="devBackdrop" class="hidden fixed inset-0 bg-dark-950/60 backdrop-blur-sm z-40 lg:hidden"></div>

      <!-- Main Chat Area -->
      <main class="flex-1 flex flex-col min-w-0 bg-dark-950 relative">
        <header class="h-14 flex items-center justify-between px-6 border-b border-dark-800 bg-dark-950/50 backdrop-blur-md z-30">
          <div class="flex items-center gap-4">
            <button id="openDevBtn" class="p-2 -ml-2 text-dark-400 hover:text-dark-100 lg:hidden">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
            <div class="flex items-center gap-2">
              <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.5)]"></div>
              <h1 class="font-display font-semibold text-dark-100">Agentic v2.0</h1>
            </div>
          </div>
          <button id="newChatBtn" class="px-4 py-1.5 bg-brand-600 hover:bg-brand-500 text-white text-xs font-semibold rounded-full transition-all shadow-lg shadow-brand-600/20 active:scale-95">
            New Session
          </button>
        </header>

        <!-- Chat Timeline -->
        <section id="chatScroller" class="flex-1 overflow-y-auto scroll-smooth custom-scrollbar">
          <div id="chatTimeline" class="max-w-4xl mx-auto px-6 py-12 space-y-10">
            <!-- Welcome State -->
            <div id="welcome-state" class="text-center py-20 space-y-6">
              <div class="w-20 h-20 bg-brand-500/10 rounded-3xl mx-auto flex items-center justify-center border border-brand-500/20 shadow-inner">
                <svg class="w-10 h-10 text-brand-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
              </div>
              <div>
                <h2 class="font-display font-bold text-4xl text-dark-50 tracking-tight">Ready for action?</h2>
                <p class="mt-3 text-dark-400 text-lg max-w-md mx-auto">Ask me to analyze data, search the web, or help with your financial accounts.</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Fixed Prompt Dock -->
        <footer class="p-6 bg-gradient-to-t from-dark-950 via-dark-950 to-transparent shrink-0">
          <div class="max-w-4xl mx-auto relative group">
            <div class="absolute -inset-1 bg-gradient-to-r from-brand-600 to-purple-600 rounded-[2rem] blur opacity-20 group-focus-within:opacity-40 transition duration-500"></div>
            <div class="relative glass rounded-[1.8rem] flex items-end p-2 gap-3 shadow-2xl">
              <button class="mb-1 ml-1 p-2.5 text-dark-400 hover:text-dark-100 hover:bg-dark-800 rounded-full transition-all" title="Attachments">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
              </button>
              
              <div class="flex-1 min-w-0 py-2">
                <textarea id="promptInput" rows="1" placeholder="Type your request here..." class="w-full bg-transparent text-dark-100 placeholder-dark-500 outline-none resize-none max-h-48 text-lg leading-relaxed px-2"></textarea>
              </div>

              <button id="sendBtn" class="mb-1 mr-1 p-3 bg-brand-600 text-white rounded-full hover:bg-brand-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-brand-600/30 active:scale-90">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 12h14M12 5l7 7-7 7"/></svg>
              </button>
            </div>
            <p class="mt-4 text-center text-[11px] text-dark-500 font-medium">Session ID: <span id="display-sid" class="text-dark-400 font-mono">None</span> â€¢ <span class="text-brand-500/60 uppercase tracking-tighter">AI Powered Logic Engine</span></p>
          </div>
        </footer>
      </main>
    </div>

    <!-- UI Templates -->
    <template id="template-user">
      <div class="flex justify-end message-enter">
        <div class="max-w-[85%] lg:max-w-[70%] bg-brand-600 text-white rounded-[2rem] rounded-tr-sm px-6 py-4 shadow-xl shadow-brand-600/10">
          <p class="text-[1.05rem] leading-relaxed break-words"></p>
        </div>
      </div>
    </template>

    <template id="template-assistant">
      <div class="flex gap-4 message-enter group">
        <div class="w-10 h-10 rounded-2xl bg-dark-850 border border-dark-700 flex items-center justify-center shrink-0 shadow-sm mt-1">
          <svg class="w-6 h-6 text-brand-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
        </div>
        <div class="flex-1 min-w-0 space-y-4">
          <!-- Thought Trace Section -->
          <div class="thought-trace hidden">
            <button onclick="toggleThought(this)" class="flex items-center gap-2 text-[11px] font-bold uppercase tracking-widest text-dark-500 hover:text-brand-400 transition-colors uppercase">
              <svg class="w-3 h-3 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"/></svg>
              Thought Process
            </button>
            <div class="thought-content mt-2 ml-1 pl-4 border-l border-dark-800 space-y-3 hidden">
              <div class="status-indicator flex items-center gap-2 text-xs text-brand-400/80 italic font-medium">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-brand-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-brand-500"></span>
                </span>
                <span class="status-text">Initializing...</span>
              </div>
              <div class="plan-steps space-y-2 hidden">
                <p class="text-[10px] text-dark-500 uppercase tracking-widest font-bold">Execution Plan</p>
                <div class="plan-list space-y-1.5"></div>
              </div>
            </div>
          </div>
          
          <div class="assistant-content text-dark-200 text-[1.05rem] leading-relaxed whitespace-pre-wrap"></div>
          <div class="ui-blocks empty:hidden space-y-4"></div>
        </div>
      </div>
    </template>

    <script>
      // Tab Management
      function switchTab(tabId) {
        ['controls', 'events', 'raw'].forEach(id => {
          document.getElementById(`panel-${id}`).classList.add('hidden');
          document.getElementById(`tab-${id}`).classList.remove('bg-dark-800/30', 'text-brand-400', 'border-brand-500');
          document.getElementById(`tab-${id}`).classList.add('text-dark-400', 'border-transparent');
        });
        document.getElementById(`panel-${tabId}`).classList.remove('hidden');
        document.getElementById(`tab-${tabId}`).classList.add('bg-dark-800/30', 'text-brand-400', 'border-brand-500');
        document.getElementById(`tab-${tabId}`).classList.remove('text-dark-400', 'border-transparent');
      }

      // UI Definitions
      const openDevBtn = document.getElementById('openDevBtn');
      const closeDevBtn = document.getElementById('closeDevBtn');
      const devPanel = document.getElementById('devPanel');
      const devBackdrop = document.getElementById('devBackdrop');
      const urlInput = document.getElementById('urlInput');
      const promptInput = document.getElementById('promptInput');
      const sendBtn = document.getElementById('sendBtn');
      const chatScroller = document.getElementById('chatScroller');
      const chatTimeline = document.getElementById('chatTimeline');
      const welcomeState = document.getElementById('welcome-state');
      const displaySid = document.getElementById('display-sid');

      urlInput.value = `${window.location.origin}/api/invoke`;

      function openDev() { devPanel.classList.remove('-translate-x-full'); devBackdrop.classList.remove('hidden'); }
      function closeDev() { devPanel.classList.add('-translate-x-full'); devBackdrop.classList.add('hidden'); }
      
      openDevBtn.addEventListener('click', openDev);
      closeDevBtn.addEventListener('click', closeDev);
      devBackdrop.addEventListener('click', closeDev);

      // Event Logic
      function appendEventLine(obj) {
        const eventsPanel = document.getElementById('eventsPanel');
        const ts = new Date().toLocaleTimeString();
        eventsPanel.textContent += `[${ts}] ${JSON.stringify(obj)}\n`;
        eventsPanel.scrollTop = eventsPanel.scrollHeight;
      }

      function updateSessionId(sid) {
        document.getElementById('sessionIdInput').value = sid;
        displaySid.textContent = sid.slice(0, 8) + '...';
      }

      function createBubble(role, content) {
        if (welcomeState) welcomeState.remove();
        
        const templateId = role === 'user' ? 'template-user' : 'template-assistant';
        const template = document.getElementById(templateId);
        const clone = template.content.cloneNode(true);
        
        if (role === 'user') {
          clone.querySelector('p').textContent = content;
        } else {
          clone.querySelector('.assistant-content').textContent = content;
        }
        
        const node = clone.firstElementChild;
        chatTimeline.appendChild(node);
        chatScroller.scrollTop = chatScroller.scrollHeight;
        return node;
      }

      function toggleThought(btn) {
        const content = btn.nextElementSibling;
        const icon = btn.querySelector('svg');
        content.classList.toggle('hidden');
        icon.classList.toggle('-rotate-90');
      }

      function updateThoughtStatus(node, text) {
        const thoughtSection = node.querySelector('.thought-trace');
        thoughtSection.classList.remove('hidden');
        const statusText = node.querySelector('.status-text');
        statusText.textContent = text;
      }

      function renderPlan(node, plan) {
        const thoughtSection = node.querySelector('.thought-trace');
        thoughtSection.classList.remove('hidden');
        const planSection = node.querySelector('.plan-steps');
        planSection.classList.remove('hidden');
        const list = node.querySelector('.plan-list');
        list.innerHTML = '';
        
        plan.steps.forEach((step, idx) => {
          const item = document.createElement('div');
          item.id = `step-${idx + 1}`;
          item.className = 'flex items-start gap-3 text-xs text-dark-400 transition-colors';
          item.innerHTML = `
            <div class="w-4 h-4 rounded-full border border-dark-700 flex items-center justify-center text-[9px] font-bold shrink-0 mt-0.5 step-icon">
              ${idx + 1}
            </div>
            <div class="flex-1 min-w-0">
              <p class="font-medium text-dark-200 step-title">${step.title}</p>
              <p class="text-[10px] text-dark-500 mt-0.5">${step.instruction}</p>
            </div>
          `;
          list.appendChild(item);
        });
      }

      function updateStepResult(node, idx, content) {
        const step = node.querySelector(`#step-${idx}`);
        if (!step) return;
        
        step.classList.remove('text-dark-400');
        step.classList.add('text-brand-400');
        const icon = step.querySelector('.step-icon');
        icon.classList.remove('border-dark-700');
        icon.classList.add('border-brand-500', 'bg-brand-500/10');
        icon.innerHTML = '<svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>';
      }

      function renderCard(card) {
        const div = document.createElement('div');
        div.className = 'glass rounded-2xl p-4 shadow-sm group hover:border-brand-500/30 transition-all';
        div.innerHTML = `
          <h4 class="text-[10px] uppercase font-bold tracking-widest text-dark-500 group-hover:text-brand-400 transition-colors">${card.title}</h4>
          <div class="mt-1 flex items-baseline gap-2">
            <span class="text-2xl font-display font-bold text-dark-50">${card.value}</span>
          </div>
          <p class="mt-1 text-xs text-dark-400 font-medium">${card.description}</p>
        `;
        return div;
      }

      function renderTable(table) {
        const wrap = document.createElement('div');
        wrap.className = 'glass rounded-2xl overflow-hidden border border-dark-800 shadow-xl';
        
        if (table.title) {
          const t = document.createElement('div');
          t.className = 'px-4 py-3 border-b border-dark-800 bg-dark-900/50';
          t.innerHTML = `<h4 class="text-xs font-bold text-dark-300">${table.title}</h4>`;
          wrap.appendChild(t);
        }

        const overflow = document.createElement('div');
        overflow.className = 'overflow-x-auto';
        
        const tbl = document.createElement('table');
        tbl.className = 'w-full text-left text-xs border-collapse';
        
        const thead = document.createElement('thead');
        thead.className = 'bg-dark-900/50 text-dark-400 font-bold uppercase tracking-wider text-[10px]';
        const htr = document.createElement('tr');
        table.columns.forEach(c => {
          const th = document.createElement('th');
          th.className = 'px-4 py-3 border-b border-dark-800';
          th.textContent = c;
          htr.appendChild(th);
        });
        thead.appendChild(htr);
        tbl.appendChild(thead);

        const tbody = document.createElement('tbody');
        table.rows.forEach(row => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-brand-500/5 transition-colors group';
          row.forEach(cell => {
            const td = document.createElement('td');
            td.className = 'px-4 py-3 border-b border-dark-850 text-dark-200';
            td.textContent = cell;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        tbl.appendChild(tbody);
        
        overflow.appendChild(tbl);
        wrap.appendChild(overflow);
        return wrap;
      }

      function updateUiBlock(assistantNode, uiSpec) {
        const container = assistantNode.querySelector('.ui-blocks');
        container.innerHTML = '';
        
        if (!uiSpec) return;

        if (uiSpec.summary) {
          const s = document.createElement('p');
          s.className = 'text-sm font-medium text-brand-400 px-1';
          s.textContent = uiSpec.summary;
          container.appendChild(s);
        }

        if (uiSpec.cards && uiSpec.cards.length) {
          const grid = document.createElement('div');
          grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3';
          uiSpec.cards.forEach(c => grid.appendChild(renderCard(c)));
          container.appendChild(grid);
        }

        if (uiSpec.table) {
          container.appendChild(renderTable(uiSpec.table));
        }
        
        chatScroller.scrollTop = chatScroller.scrollHeight;
      }

      async function sendRequest() {
        const prompt = promptInput.value.trim();
        if (!prompt) return;

        createBubble('user', prompt);
        const assistantNode = createBubble('assistant', 'Let me check that...');
        const contentArea = assistantNode.querySelector('.assistant-content');
        
        const isStream = document.getElementById('streamToggle').checked;
        const payload = {
          prompt,
          stream: isStream,
          trace_tools: document.getElementById('traceToggle').checked,
          generate_ui: document.getElementById('uiToggle').checked,
          session_id: document.getElementById('sessionIdInput').value || undefined,
        };

        if (document.getElementById('budgetEnabled').checked) {
          payload.plan_step_budget = parseInt(document.getElementById('budgetInput').value);
        }

        promptInput.value = '';
        autoResize();
        sendBtn.disabled = true;

        try {
          const response = await fetch(urlInput.value, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          if (!isStream) {
            const data = await response.json();
            contentArea.textContent = data.response;
            if (data.session_id) updateSessionId(data.session_id);
            if (data.ui_spec) updateUiBlock(assistantNode, data.ui_spec);
            document.getElementById('jsonPanel').textContent = JSON.stringify(data, null, 2);
          } else {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = '';
            
            contentArea.textContent = ''; // Clear initial message

            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              
              const chunk = decoder.decode(value);
              const lines = chunk.split('\n');
              
              for (const line of lines) {
                if (line.startsWith('data: ')) {
                  const data = JSON.parse(line.slice(6));
                  appendEventLine(data);

                  if (data.type === 'token') {
                    fullText += data.content;
                    contentArea.textContent = fullText;
                  } else if (data.type === 'status') {
                    updateThoughtStatus(assistantNode, data.content);
                  } else if (data.type === 'plan') {
                    renderPlan(assistantNode, data);
                  } else if (data.type === 'step_result') {
                    updateStepResult(assistantNode, data.step_index, data.content);
                  } else if (data.type === 'metadata') {
                    if (data.session_id) updateSessionId(data.session_id);
                    // Hide thought status when done if text is long, but keep plan
                    assistantNode.querySelector('.status-indicator').classList.add('hidden');
                  } else if (data.type === 'ui') {
                    updateUiBlock(assistantNode, data.payload);
                  }
                  chatScroller.scrollTop = chatScroller.scrollHeight;
                }
              }
            }
          }
        } catch (err) {
          contentArea.innerHTML = `<span class="text-red-400 font-semibold">Error:</span> ${err.message}`;
        } finally {
          sendBtn.disabled = false;
        }
      }

      function autoResize() {
        promptInput.style.height = 'auto';
        promptInput.style.height = promptInput.scrollHeight + 'px';
      }

      promptInput.addEventListener('input', autoResize);
      promptInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendRequest(); }
      });
      sendBtn.addEventListener('click', sendRequest);
      document.getElementById('newChatBtn').addEventListener('click', () => window.location.reload());
      
      // Auto-sync JSON panel
      function syncJson() {
        const p = {
          prompt: "",
          stream: document.getElementById('streamToggle').checked,
          trace_tools: document.getElementById('traceToggle').checked,
          generate_ui: document.getElementById('uiToggle').checked,
          session_id: document.getElementById('sessionIdInput').value || undefined,
        };
        document.getElementById('payloadInput').value = JSON.stringify(p, null, 2);
      }
      ['streamToggle', 'traceToggle', 'uiToggle', 'sessionIdInput', 'budgetEnabled'].forEach(id => {
        document.getElementById(id).addEventListener('change', syncJson);
      });
      syncJson();
    </script>
  </body>
</html>
